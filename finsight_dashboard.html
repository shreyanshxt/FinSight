<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FinSight Agent</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500;600&display=swap"
    rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="//unpkg.com/globe.gl"></script>
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* ... (previous vars) ... */
    :root {
      --bg: #080c10;
      --surface: #0d1117;
      --panel: #111820;
      --border: #1e2d3d;
      --accent: #00d4ff;
      --accent2: #00ff88;
      --danger: #ff4757;
      --warn: #ffa502;
      --text: #c9d4e0;
      --muted: #6a7c8d;
      --mono: 'Space Mono', monospace;
      --sans: 'DM Sans', sans-serif;
      --base-font-size: 16px;
    }

    /* ... */

    #globeViz {
      width: 100%;
      height: 350px;
      background: rgba(0, 0, 0, 0);
      border-radius: 4px;
      border: 1px solid var(--border);
      margin-bottom: 20px;
      overflow: hidden;
    }

    html,
    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
      font-size: var(--base-font-size);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Scanline overlay */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(0deg,
          transparent,
          transparent 2px,
          rgba(0, 212, 255, 0.015) 2px,
          rgba(0, 212, 255, 0.015) 4px);
      pointer-events: none;
      z-index: 9999;
    }

    /* Grid bg */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(0, 212, 255, 0.04) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 212, 255, 0.04) 1px, transparent 1px);
      background-size: 40px 40px;
      pointer-events: none;
      z-index: 0;
    }

    /* ── HEADER ── */
    header {
      position: relative;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 32px;
      border-bottom: 1px solid var(--border);
      background: rgba(8, 12, 16, 0.92);
      backdrop-filter: blur(8px);
    }

    .logo {
      display: flex;
      align-items: baseline;
      gap: 10px;
    }

    .logo-main {
      font-family: var(--mono);
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 0.06em;
      text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
    }

    .logo-sub {
      font-size: 0.72rem;
      color: var(--muted);
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .status-dot {
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: var(--mono);
      font-size: 0.72rem;
      color: var(--muted);
    }

    .dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--muted);
    }

    .dot.live {
      background: var(--accent2);
      box-shadow: 0 0 8px var(--accent2);
      animation: pulse 2s infinite;
    }

    .dot.error {
      background: var(--danger);
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.3;
      }
    }

    .time-display {
      font-family: var(--mono);
      font-size: 0.72rem;
      color: var(--muted);
    }

    /* ── MAIN LAYOUT ── */
    main {
      position: relative;
      z-index: 10;
      display: grid;
      grid-template-columns: 340px 1fr;
      grid-template-rows: auto 1fr;
      gap: 0;
      height: calc(100vh - 61px);
    }

    /* ── SIDEBAR ── */
    .sidebar {
      grid-row: 1 / 3;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      background: rgba(13, 17, 23, 0.7);
    }

    .sidebar-section {
      padding: 24px;
      border-bottom: 1px solid var(--border);
    }

    .section-label {
      font-family: var(--mono);
      font-size: 0.62rem;
      letter-spacing: 0.2em;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 16px;
    }

    .search-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .ticker-input {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--accent);
      font-family: var(--mono);
      font-size: 1.1rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 12px 16px;
      border-radius: 4px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      width: 100%;
    }

    .ticker-input::placeholder {
      color: var(--muted);
      text-transform: none;
      font-size: 0.85rem;
      letter-spacing: 0;
    }

    .ticker-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.12);
    }

    .model-select {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: var(--sans);
      font-size: 0.95rem;
      padding: 12px 16px;
      border-radius: 4px;
      outline: none;
      cursor: pointer;
      width: 100%;
      transition: border-color 0.2s;
    }

    .model-select:focus {
      border-color: var(--accent);
    }

    .analyze-btn {
      background: var(--accent);
      color: var(--bg);
      border: none;
      font-family: var(--mono);
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    .analyze-btn:hover:not(:disabled) {
      background: #33ddff;
      box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
    }

    .analyze-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .analyze-btn .btn-loading {
      display: none;
    }

    .analyze-btn.loading .btn-text {
      display: none;
    }

    .analyze-btn.loading .btn-loading {
      display: inline;
    }

    /* Quick tickers */
    .quick-tickers {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      font-family: var(--mono);
      font-size: 0.7rem;
      padding: 5px 10px;
      border: 1px solid var(--border);
      border-radius: 3px;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.15s;
      background: transparent;
    }

    .chip:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(0, 212, 255, 0.06);
    }

    /* Signal card */
    .signal-card {
      margin: 0;
    }

    .signal-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 3px;
      font-family: var(--mono);
      font-size: 0.8rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      margin-bottom: 12px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .signal-badge.visible {
      opacity: 1;
    }

    .signal-badge.BUY {
      background: rgba(0, 255, 136, 0.12);
      color: var(--accent2);
      border: 1px solid rgba(0, 255, 136, 0.3);
    }

    .signal-badge.SELL {
      background: rgba(255, 71, 87, 0.12);
      color: var(--danger);
      border: 1px solid rgba(255, 71, 87, 0.3);
    }

    .signal-badge.HOLD {
      background: rgba(255, 165, 2, 0.12);
      color: var(--warn);
      border: 1px solid rgba(255, 165, 2, 0.3);
    }

    .confidence-bar-wrap {
      margin-bottom: 12px;
    }

    .confidence-label {
      font-size: 0.72rem;
      color: var(--muted);
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
    }

    .confidence-bar {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
    }

    .confidence-fill {
      height: 100%;
      border-radius: 2px;
      width: 0%;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .confidence-fill.BUY {
      background: var(--accent2);
      box-shadow: 0 0 8px var(--accent2);
    }

    .confidence-fill.SELL {
      background: var(--danger);
      box-shadow: 0 0 8px var(--danger);
    }

    .confidence-fill.HOLD {
      background: var(--warn);
      box-shadow: 0 0 8px var(--warn);
    }

    .reasoning-box {
      font-size: 1rem;
      line-height: 1.6;
      color: var(--text);
      padding: 18px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      max-height: 250px;
      overflow-y: auto;
      opacity: 0;
      transition: opacity 0.3s 0.2s;
    }

    .reasoning-box.visible {
      opacity: 1;
    }

    .reasoning-box::-webkit-scrollbar {
      width: 4px;
    }

    .reasoning-box::-webkit-scrollbar-track {
      background: transparent;
    }

    .reasoning-box::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px;
    }

    /* History */
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.15s;
      font-size: 0.8rem;
    }

    .history-item:hover {
      border-color: var(--accent);
    }

    .history-ticker {
      font-family: var(--mono);
      color: var(--accent);
      font-size: 0.78rem;
    }

    .history-signal {
      font-family: var(--mono);
      font-size: 0.7rem;
      font-weight: 700;
    }

    .history-signal.BUY {
      color: var(--accent2);
    }

    .history-signal.SELL {
      color: var(--danger);
    }

    .history-signal.HOLD {
      color: var(--warn);
    }

    /* ── CONTENT AREA ── */
    .content-top {
      padding: 24px 28px 0;
      border-bottom: 1px solid var(--border);
    }

    .content-main {
      padding: 16px 28px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
      min-width: 0;
    }

    /* Ticker header */
    .ticker-header {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      padding-bottom: 20px;
      min-height: 72px;
    }

    .ticker-name {
      font-family: var(--mono);
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent);
      text-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
      letter-spacing: 0.08em;
    }

    .ticker-price {
      font-family: var(--mono);
      font-size: 1.5rem;
      color: var(--text);
    }

    .ticker-change {
      font-family: var(--mono);
      font-size: 0.85rem;
      padding: 4px 10px;
      border-radius: 3px;
      margin-left: 12px;
    }

    .ticker-change.pos {
      background: rgba(0, 255, 136, 0.1);
      color: var(--accent2);
    }

    .ticker-change.neg {
      background: rgba(255, 71, 87, 0.1);
      color: var(--danger);
    }

    /* Metrics row */
    .metrics-grid {
      display: flex;
      flex-wrap: nowrap;
      gap: 10px;
      padding-bottom: 8px;
      overflow-x: auto;
      scrollbar-width: thin;
    }

    .metrics-grid::-webkit-scrollbar {
      height: 4px;
    }

    .metrics-grid::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px;
    }

    .metric-card,
    .indicator-panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 12px 16px;
      flex: 1 1 auto;
      min-width: 130px;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 0.3s, transform 0.3s;
    }

    .metric-card.visible,
    .indicator-panel.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .metric-label,
    .indicator-name {
      font-family: var(--mono);
      font-size: 0.6rem;
      letter-spacing: 0.15em;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .metric-value,
    .indicator-value {
      font-family: var(--mono);
      font-size: 1.1rem;
      color: var(--text);
    }

    .metric-value.up {
      color: var(--accent2);
    }

    .metric-value.down {
      color: var(--danger);
    }

    .metric-value.neutral {
      color: var(--warn);
    }

    /* Chart panel */
    .chart-panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 20px;
      opacity: 0;
      transition: opacity 0.4s 0.1s;
    }

    .chart-panel.visible {
      opacity: 1;
    }

    /* Toast Notification */
    #toastContainer {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: none;
    }

    .toast {
      pointer-events: auto;
      background: rgba(13, 17, 23, 0.95);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border);
      padding: 16px 24px;
      border-radius: 6px;
      color: var(--text);
      font-family: var(--sans);
      font-size: 0.95rem;
      min-width: 300px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
      transform: translateX(120%);
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .toast.visible {
      transform: translateX(0);
    }

    .toast-success {
      border-left: 4px solid var(--accent2);
    }

    .toast-error {
      border-left: 4px solid var(--danger);
    }

    .toast-info {
      border-left: 4px solid var(--accent);
    }

    .toast-close {
      cursor: pointer;
      color: var(--muted);
      font-size: 1.2rem;
      line-height: 1;
    }

    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .chart-title {
      font-family: var(--mono);
      font-size: 0.7rem;
      letter-spacing: 0.15em;
      color: var(--muted);
      text-transform: uppercase;
    }

    .chart-tabs {
      display: flex;
      gap: 4px;
    }

    .chart-tab {
      font-family: var(--mono);
      font-size: 0.65rem;
      padding: 4px 10px;
      border: 1px solid var(--border);
      border-radius: 3px;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.15s;
    }

    .chart-tab.active,
    .chart-tab:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(0, 212, 255, 0.06);
    }

    .chart-container {
      position: relative;
      height: 200px;
      /* Reduced for "small sized" look */
      width: 100%;
    }

    /* Indicators row */
    .indicators-grid {
      display: flex;
      flex-wrap: nowrap;
      gap: 12px;
      overflow-x: auto;
      padding-bottom: 8px;
    }

    .indicator-status {
      font-family: var(--mono);
      font-size: 0.65rem;
      color: var(--muted2);
      margin-top: 4px;
    }


    /* Loading skeleton */
    .skeleton {
      background: linear-gradient(90deg, var(--panel) 25%, var(--border) 50%, var(--panel) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 3px;
      height: 14px;
    }

    @keyframes shimmer {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    /* Error state */
    .error-message {
      display: none;
      padding: 12px 16px;
      background: rgba(255, 71, 87, 0.08);
      border: 1px solid rgba(255, 71, 87, 0.3);
      border-radius: 4px;
      color: var(--danger);
      font-family: var(--mono);
      font-size: 0.78rem;
    }

    .error-message.visible {
      display: block;
    }

    /* Empty state */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      gap: 16px;
      color: var(--muted);
      font-family: var(--mono);
    }

    .empty-state-glyph {
      font-size: 3rem;
      opacity: 0.2;
    }

    .empty-state-text {
      font-size: 0.75rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }

    /* Toggle Switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 34px;
      height: 20px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background-color: var(--border);
      transition: .4s;
      border-radius: 20px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 3px;
      bottom: 3px;
      background-color: var(--text);
      transition: .4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: var(--accent2);
    }

    input:checked+.slider:before {
      transform: translateX(14px);
    }

    /* Portfolio Specific */
    .view-switcher {
      display: flex;
      gap: 15px;
      margin-bottom: 24px;
      position: relative;
      z-index: 20;
    }

    .view-tab {
      font-family: var(--mono);
      font-size: 0.75rem;
      letter-spacing: 0.1em;
      color: var(--muted);
      cursor: pointer;
      padding-bottom: 6px;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .view-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .portfolio-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 25px;
    }

    .acc-card {
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 20px;
      border-radius: 4px;
    }

    .acc-label {
      font-family: var(--mono);
      font-size: 0.65rem;
      color: var(--muted);
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .acc-val {
      font-family: var(--mono);
      font-size: 1.5rem;
      color: var(--text);
    }

    .position-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.85rem;
    }

    .position-table th {
      text-align: left;
      padding: 12px;
      font-family: var(--mono);
      font-size: 0.65rem;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
    }

    .position-table td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      color: var(--text);
    }

    .pl-up {
      color: var(--accent2);
    }

    .pl-down {
      color: var(--danger);
    }

    .sim-badge {
      display: inline-block;
      padding: 4px 10px;
      font-family: var(--mono);
      font-size: 0.65rem;
      border-radius: 20px;
      background: rgba(0, 212, 255, 0.1);
      color: var(--accent);
      border: 1px solid var(--accent);
      margin-left: 15px;
      letter-spacing: 0.05em;
    }

    .risk-badge {
      font-family: var(--mono);
      font-size: 0.65rem;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 3px;
      text-transform: uppercase;
    }

    .risk-low {
      background: rgba(0, 255, 136, 0.1);
      color: var(--accent2);
      border: 1px solid rgba(0, 255, 136, 0.3);
    }

    .risk-med {
      background: rgba(255, 165, 2, 0.1);
      color: var(--warn);
      border: 1px solid rgba(255, 165, 2, 0.3);
    }

    .risk-high {
      background: rgba(255, 71, 87, 0.1);
      color: var(--danger);
      border: 1px solid rgba(255, 71, 87, 0.3);
    }


    /* Responsive */
    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
      }

      .sidebar {
        grid-row: auto;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }

      .indicators-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>

<body>

  <!-- Toast Container -->
  <div id="toastContainer"></div>

  <!-- HEADER -->
  <header>
    <div class="logo">
      <span class="logo-main">FINSIGHT</span>
      <span class="logo-sub">AI Trading Agent</span>
    </div>
    <div class="header-right">
      <div class="status-dot">
        <div class="dot" id="apiDot"></div>
        <span id="apiStatus">connecting...</span>
      </div>
      <div class="time-display" id="clock">--:--:--</div>
    </div>
  </header>

  <main>

    <aside class="sidebar">

      <!-- GLOBE VIZ -->
      <div id="sidebarGlobe" class="sidebar-section" style="padding: 10px; border-bottom: 1px solid var(--border);">
        <div id="globeViz" style="width: 100%; height: 200px; border-radius: 4px; overflow: hidden;"></div>
      </div>

      <!-- Autonomous Toggle & Settings -->
      <div class="sidebar-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
          <div class="section-label" style="margin-bottom:0">Autonomous Mode</div>
          <label class="switch">
            <input type="checkbox" id="autoToggle" onchange="toggleAgent(this.checked)" checked>
            <span class="slider"></span>
          </label>
        </div>

        <!-- Capital Allocation -->
        <div style="margin-bottom:10px">
          <label style="font-size:0.6rem; color:var(--muted); display:block; margin-bottom:4px">AGENT CAPITAL
            ($)</label>
          <div style="display:flex; gap:6px">
            <input type="number" id="agentAllocInput" class="ticker-input" value="0"
              style="font-size:0.8rem; padding:6px 10px">
            <button class="chart-tab" onclick="setAgentAllocation()"
              style="padding:6px 10px; border-color:var(--accent2); color:var(--accent2)">SET</button>
          </div>
        </div>

        <div style="font-size:0.6rem; color:var(--muted); margin-top:8px; line-height:1.4">When enabled, the AI will
          automatically execute trades based on analysis using allocated capital.</div>
      </div>

      <!-- Search -->
      <div class="sidebar-section">
        <div class="section-label">Analyze Ticker</div>
        <div class="search-group">
          <input class="ticker-input" id="tickerInput" type="text" placeholder="e.g. AAPL, BTC-USD" maxlength="12" />
          <select class="model-select" id="modelSelect" onchange="updateAgentModel(this.value)">
            <option value="llama3.1">llama3.1 (Recommended)</option>
            <option value="llama3">llama3</option>
            <option value="phi3">phi3 (Lightweight)</option>
            <option value="tinyllama">tinyllama (Ultra-Light)</option>
            <option value="gpt-4o">gpt-4o</option>
            <option value="gemini-2.0-flash">gemini-2.0-flash</option>
          </select>
          <button class="analyze-btn" id="analyzeBtn" onclick="runAnalysis()">
            <span class="btn-text">▶ Run Analysis</span>
            <span class="btn-loading">● Analyzing...</span>
          </button>
          <div class="error-message" id="errorMsg"></div>
        </div>
      </div>

      <!-- Quick tickers -->
      <div class="sidebar-section">
        <div class="section-label">Quick Select</div>
        <div class="quick-tickers">
          <button class="chip" onclick="quickTicker('AAPL')">AAPL</button>
          <button class="chip" onclick="quickTicker('GOOGL')">GOOGL</button>
          <button class="chip" onclick="quickTicker('MSFT')">MSFT</button>
          <button class="chip" onclick="quickTicker('TSLA')">TSLA</button>
          <button class="chip" onclick="quickTicker('NVDA')">NVDA</button>
          <button class="chip" onclick="quickTicker('BTC-USD')">BTC</button>
          <button class="chip" onclick="quickTicker('ETH-USD')">ETH</button>
          <button class="chip" onclick="quickTicker('AMZN')">AMZN</button>
        </div>
      </div>

      <!-- Signal output -->
      <div class="sidebar-section signal-card">
        <div class="section-label">Signal</div>
        <div class="signal-badge" id="signalBadge">—</div>
        <div class="confidence-bar-wrap" id="confWrap" style="display:none">
          <div class="confidence-label">
            <span>Confidence</span>
            <span id="confPct">—</span>
          </div>
          <div class="confidence-bar">
            <div class="confidence-fill" id="confFill"></div>
          </div>
        </div>
        <div class="reasoning-box" id="reasoningBox">
          Run an analysis to see AI reasoning here.
        </div>
      </div>

      <!-- Trading Execution Panel -->
      <div class="sidebar-section">
        <div class="section-label">Trade Execution</div>
        <div class="search-group">
          <div style="display:flex; gap:10px; align-items:center; margin-bottom: 5px;">
            <div style="flex:1">
              <label style="font-size:0.6rem; color:var(--muted); display:block; margin-bottom:4px">AMOUNT</label>
              <input type="number" id="tradeQty" class="ticker-input" value="1" min="1"
                style="font-size:0.9rem; padding:8px 12px">
            </div>
            <div style="flex:1">
              <label style="font-size:0.6rem; color:var(--muted); display:block; margin-bottom:4px">DECISION</label>
              <div style="display:flex; border:1px solid var(--border); border-radius:4px; overflow:hidden">
                <button id="buyBtn" onclick="setSide('buy')"
                  style="flex:1; background:transparent; border:none; color:var(--muted); cursor:pointer; padding:6px; font-weight:bold; font-size:0.7rem; border-right:1px solid var(--border)">BUY</button>
                <button id="sellBtn" onclick="setSide('sell')"
                  style="flex:1; background:transparent; border:none; color:var(--muted); cursor:pointer; padding:6px; font-weight:bold; font-size:0.7rem;">SELL</button>
              </div>
            </div>
          </div>

          <label style="font-size:0.6rem; color:var(--muted); display:block; margin-bottom:4px">STRATEGY</label>
          <select class="model-select" id="strategySelect" style="margin-bottom: 10px;">
            <option value="market">Market Order</option>
            <option value="limit">Limit Order</option>
            <option value="momentum">Momentum Trend</option>
            <option value="mean_reversion">Mean Reversion</option>
            <option value="breakout">Volatility Breakout</option>
            <option value="ai_optimized">AI Optimized</option>
          </select>

          <button class="analyze-btn" id="placeTradeBtn" onclick="placeTrade()"
            style="background:var(--accent2); color:var(--bg)">
            <span class="btn-text">⚡ Place Strategy Trade</span>
            <span class="btn-loading">Executing...</span>
          </button>
          <div id="tradeStatus" style="font-size:0.7rem; margin-top:10px; font-family:var(--mono);"></div>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="section-label">Recent</div>
        <div class="history-list" id="historyList">
          <div style="font-size:0.75rem; color:var(--muted); font-family:var(--mono)">No analyses yet.</div>
        </div>
      </div>

    </aside>

    <!-- TOP CONTENT: Ticker header -->
    <div class="content-top">
      <!-- View Switcher -->
      <div class="view-switcher">
        <div class="view-tab active" id="tabAnalysis" onclick="switchView('analysis')">LIVE ANALYSIS</div>
        <div class="view-tab" id="tabPortfolio" onclick="switchView('portfolio')">PORTFOLIO & ACCOUNT</div>
      </div>

      <div id="analysisView">
        <div class="ticker-header" id="tickerHeader">
          <div style="display:flex;align-items:baseline;gap:12px">
            <div class="ticker-name" id="displayTicker">—</div>
            <div style="display:flex;align-items:center">
              <div class="ticker-price" id="displayPrice">—</div>
              <div class="ticker-change" id="displayChange"></div>
            </div>
          </div>
          <div style="font-family:var(--mono);font-size:0.7rem;color:var(--muted)" id="lastUpdated">Awaiting analysis
          </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="content-main" id="contentMain">
          <!-- Empty state -->
          <div class="empty-state" id="emptyState">
            <div class="empty-state-glyph">◈</div>
            <div class="empty-state-text">Enter a ticker to begin</div>
          </div>

          <!-- Metrics grid (hidden until data) -->
          <div class="metrics-grid" id="metricsGrid" style="display:none"></div>

          <!-- Price chart -->
          <div class="chart-panel" id="chartPanel" style="display:none">
            <div class="chart-header">
              <span class="chart-title">Price History</span>
              <div class="chart-tabs">
                <button class="chart-tab active" onclick="switchChart('price', this)">Price</button>
                <button class="chart-tab" onclick="switchChart('rsi', this)">RSI</button>
                <button class="chart-tab" onclick="switchChart('macd', this)">MACD</button>
              </div>
            </div>
            <div class="chart-container">
              <canvas id="mainChart"></canvas>
            </div>
          </div>

          <!-- Indicators -->
          <div class="indicators-grid" id="indicatorsGrid" style="display:none"></div>
        </div>
      </div>

      <!-- Portfolio View -->
      <div id="portfolioView" style="display:none; padding: 20px;">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px">
          <div style="display:flex; align-items:center; gap:15px">
            <div class="section-label" style="margin:0">Portfolio Summary</div>
            <div class="chart-tabs">
              <button class="chart-tab active" id="btnPortTotal" onclick="switchPortView('total')">TOTAL</button>
              <button class="chart-tab" id="btnPortAgent" onclick="switchPortView('agent')">AGENT ONLY</button>
            </div>
          </div>
          <div id="simModeBadge" class="sim-badge" style="display:none">◈ NEURAL SIMULATION ACTIVE</div>
        </div>

        <div class="portfolio-grid">
          <div class="acc-card">
            <div class="acc-label">Net Equity</div>
            <div class="acc-val" id="accEquity">$0.00</div>
          </div>
          <div class="acc-card">
            <div class="acc-label">Buying Power</div>
            <div class="acc-val" id="accBuyingPower">$0.00</div>
          </div>
          <div class="acc-card">
            <div class="acc-label">Cash</div>
            <div class="acc-val" id="accCash">$0.00</div>
          </div>
          <div class="acc-card">
            <div class="acc-label">Net Profit</div>
            <div class="acc-val up" id="accNetProfit">$0.00</div>
          </div>
          <div class="acc-card">
            <div class="acc-label">Net Loss</div>
            <div class="acc-val down" id="accNetLoss">$0.00</div>
          </div>
          <div class="acc-card">
            <div class="acc-label">Max Drawdown</div>
            <div class="acc-val down" id="accDrawdown">0.00%</div>
          </div>
        </div>

        <div id="pendingOrdersContainer" class="acc-card" style="margin-bottom: 30px; display: none;">
          <div class="section-label" style="margin-top:0; color: var(--warn);">Pending Orders</div>
          <table class="position-table">
            <thead>
              <tr>
                <th>SYMBOL</th>
                <th>SIDE</th>
                <th>QTY</th>
                <th>STATUS</th>
                <th>SUBMITTED</th>
              </tr>
            </thead>
            <tbody id="orderList"></tbody>
          </table>
        </div>

        <div class="acc-card" style="margin-bottom: 30px;">
          <div class="section-label" style="margin-top:0">Open Positions</div>
          <table class="position-table">
            <thead>
              <tr>
                <th>SYMBOL</th>
                <th>QTY</th>
                <th>AVG PRICE</th>
                <th>CURR PRICE</th>
                <th>STOP LOSS</th>
                <th>RISK</th>
                <th>P&L ($)</th>
                <th>P&L (%)</th>
              </tr>
            </thead>
            <tbody id="positionList">
              <tr>
                <td colspan="8" style="text-align:center; color:var(--muted); padding:30px">Loading positions...</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px;">
          <!-- Performance Graph -->
          <div class="chart-panel visible" id="performancePanel" style="margin-bottom: 0;">
            <div class="chart-header">
              <span class="chart-title">Equity Performance (Neural Simulation)</span>
            </div>
            <div class="chart-container" style="height: 250px;">
              <canvas id="performanceChart"></canvas>
            </div>
          </div>

          <!-- Top Performers Graph -->
          <div class="chart-panel visible" id="topPerformersPanel" style="margin-bottom: 0;">
            <div class="chart-header">
              <span class="chart-title">Top Performing Stocks</span>
            </div>
            <div class="chart-container" style="height: 250px;">
              <canvas id="topPerformersChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Trade History Section -->
        <div class="acc-card" style="margin-bottom: 30px;">
          <div class="section-label" style="margin-top:0">Completed Trades (Agent vs Manual)</div>
          <table class="position-table">
            <thead>
              <tr>
                <th>TIME</th>
                <th>SYMBOL</th>
                <th>SIDE</th>
                <th>QTY</th>
                <th>PRICE</th>
                <th>SOURCE</th>
              </tr>
            </thead>
            <tbody id="tradeHistoryList">
              <tr>
                <td colspan="6" style="text-align:center; color:var(--muted); padding:30px">No trades recorded.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ── CONFIG ──────────────────────────────────────────────────
    const API_BASE = window.location.origin;  // Dynamic to current host

    // ── STATE ───────────────────────────────────────────────────
    let chartInstance = null;
    let perfChartInstance = null;
    let topPerformersChartInstance = null;
    let currentData = null;
    let analysisHistory = [];
    let currentChartType = 'price';
    let tradeSide = 'buy';
    let accountPolling = null;

    function setSide(side) {
      tradeSide = side;
      const buyBtn = document.getElementById('buyBtn');
      const sellBtn = document.getElementById('sellBtn');
      if (side === 'buy') {
        buyBtn.style.background = 'rgba(0,255,136,0.15)';
        buyBtn.style.color = 'var(--accent2)';
        sellBtn.style.background = 'transparent';
        sellBtn.style.color = 'var(--muted)';
      } else {
        sellBtn.style.background = 'rgba(255,71,87,0.15)';
        sellBtn.style.color = 'var(--danger)';
        buyBtn.style.background = 'transparent';
        buyBtn.style.color = 'var(--muted)';
      }
    }
    // Initialize side UI
    setTimeout(() => setSide('buy'), 100);

    async function placeTrade() {
      const ticker = document.getElementById('displayTicker').textContent.trim();
      const qty = parseInt(document.getElementById('tradeQty').value);
      const strategy = document.getElementById('strategySelect').value;
      const btn = document.getElementById('placeTradeBtn');
      const status = document.getElementById('tradeStatus');

      if (ticker === '—') {
        status.textContent = 'Error: No ticker selected.';
        status.style.color = 'var(--danger)';
        return;
      }

      btn.disabled = true;
      btn.classList.add('loading');
      status.textContent = 'Submitting trade...';
      status.style.color = 'var(--muted)';

      try {
        const res = await fetch(`${API_BASE}/trade`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ticker, qty, side: tradeSide, strategy })
        });

        const result = await res.json();
        if (!res.ok) throw new Error(result.detail || 'Trade failed');

        status.textContent = `Success: Order ${result.status || 'placed'}!`;
        status.style.color = 'var(--accent2)';
      } catch (err) {
        status.textContent = `Error: ${err.message}`;
        status.style.color = 'var(--danger)';
      } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
      }
    }

    // ── CLOCK ───────────────────────────────────────────────────
    function updateClock() {
      const now = new Date();
      document.getElementById('clock').textContent =
        now.toLocaleTimeString('en-US', { hour12: false });
    }
    setInterval(updateClock, 1000);
    updateClock();

    // ── HEALTH CHECK ─────────────────────────────────────────────
    async function checkHealth() {
      const dot = document.getElementById('apiDot');
      const status = document.getElementById('apiStatus');
      try {
        const res = await fetch(`${API_BASE}/health`, { signal: AbortSignal.timeout(3000) });
        if (res.ok) {
          dot.className = 'dot live';
          status.textContent = 'API online';
        } else {
          dot.className = 'dot error';
          status.textContent = 'API error';
        }
      } catch {
        dot.className = 'dot error';
        status.textContent = 'API offline';
      }
    }
    checkHealth();
    setInterval(checkHealth, 15000);

    // ── AGENT CONFIG ─────────────────────────────────────────────
    async function loadAgentConfig() {
      try {
        const res = await fetch(`${API_BASE}/agent/config`);
        const data = await res.json();
        document.getElementById('autoToggle').checked = data.autonomous_enabled;
      } catch (e) { console.error('Failed to load agent config', e); }
    }
    loadAgentConfig();

    async function toggleAgent(enabled) {
      try {
        const response = await fetch(`${API_BASE}/agent/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled })
        });
        const result = await response.json();
        console.log('Agent status updated:', result);
      } catch (error) {
        console.error('Failed to toggle agent:', error);
      }
    }

    async function updateAgentModel(model) {
      try {
        const response = await fetch(`${API_BASE}/agent/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model })
        });
        const result = await response.json();
        console.log('Agent model updated:', result);
      } catch (error) {
        console.error('Failed to update agent model:', error);
      }
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <span>${message}</span>
        <span class="toast-close" onclick="this.parentElement.classList.remove('visible'); setTimeout(()=>this.parentElement.remove(), 400)">&times;</span>
      `;
      container.appendChild(toast);
      setTimeout(() => toast.classList.add('visible'), 10);
      setTimeout(() => {
        toast.classList.remove('visible');
        setTimeout(() => toast.remove(), 400);
      }, 5000);
    }

    async function setAgentAllocation() {
      const val = parseFloat(document.getElementById('agentAllocInput').value);
      if (isNaN(val) || val < 0) return;

      try {
        const res = await fetch(`${API_BASE}/agent/allocation`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount: val })
        });
        if (res.ok) {
          showToast(`Successfully allocated $${val.toLocaleString()} to Agent`, 'success');
          if (typeof loadAccount === 'function') loadAccount();
        } else {
          showToast('Failed to set allocation', 'error');
        }
      } catch (e) {
        showToast('Error setting allocation', 'error');
      }
    }

    // ── VIEW SWITCHING ──────────────────────────────────────────
    function switchView(view) {
      const isAnalysis = view === 'analysis';
      document.getElementById('tabAnalysis').classList.toggle('active', isAnalysis);
      document.getElementById('tabPortfolio').classList.toggle('active', !isAnalysis);
      document.getElementById('analysisView').style.display = isAnalysis ? 'block' : 'none';
      document.getElementById('portfolioView').style.display = isAnalysis ? 'none' : 'block';

      if (!isAnalysis) {
        loadAccount();
        loadPerformance();
        loadTrades();
        if (!accountPolling) {
          accountPolling = setInterval(() => {
            loadAccount();
            loadPerformance();
            loadTrades();
          }, 10000); // 10s refresh
        }
      } else {
        if (accountPolling) {
          clearInterval(accountPolling);
          accountPolling = null;
        }
      }
    }

    async function loadTrades() {
      const list = document.getElementById('tradeHistoryList');
      try {
        const res = await fetch(`${API_BASE}/trades`);
        const trades = await res.json();

        if (!trades || trades.length === 0) {
          list.innerHTML = `<tr><td colspan="6" style="text-align:center; color:var(--muted); padding:30px">No trades recorded.</td></tr>`;
          return;
        }

        // Reverse to show newest first
        const sorted = trades.slice().reverse();

        list.innerHTML = sorted.map(t => {
          const cls = t.side.toLowerCase() === 'buy' ? 'pl-up' : 'pl-down';
          const isAgent = t.source === 'agent';
          const sourceCls = isAgent ? 'color: var(--accent2)' : 'color: var(--warn)';
          const sourceLabel = isAgent ? 'AGENT' : 'MANUAL';
          const time = new Date(t.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

          return `
            <tr>
              <td style="font-family: var(--mono); font-size: 0.75rem">${time}</td>
              <td style="font-weight:bold">${t.symbol}</td>
              <td class="${cls}" style="font-weight:bold">${t.side.toUpperCase()}</td>
              <td>${t.qty}</td>
              <td>$${Number(t.price).toFixed(2)}</td>
              <td style="font-family: var(--mono); font-size: 0.7rem; font-weight: bold; ${sourceCls}">${sourceLabel}</td>
            </tr>
          `;
        }).join('');
      } catch (e) { console.error('Failed to load trades', e); }
    }

    async function loadPerformance() {
      try {
        const res = await fetch(`${API_BASE}/performance`);
        const history = await res.json();
        if (!history || history.length === 0) return;

        renderPerformanceChart(history);
      } catch (e) { console.error('Failed to load performance', e); }
    }

    function renderPerformanceChart(history) {
      const ctx = document.getElementById('performanceChart').getContext('2d');
      const labels = history.map(h => new Date(h.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
      const values = history.map(h => h.equity);

      if (perfChartInstance) { perfChartInstance.destroy(); }

      const grad = ctx.createLinearGradient(0, 0, 0, 250);
      grad.addColorStop(0, 'rgba(0,255,136,0.2)');
      grad.addColorStop(1, 'rgba(0,255,136,0)');

      perfChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Equity',
            data: values,
            borderColor: '#00ff88',
            borderWidth: 2,
            backgroundColor: grad,
            fill: true,
            tension: 0.4,
            pointRadius: 0,
            pointHoverRadius: 4,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: { label: ctx => ` $${ctx.parsed.y.toLocaleString()}` }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: '#4a5a6a', font: { family: 'Space Mono', size: 9 }, maxTicksLimit: 10 }
            },
            y: {
              grid: { color: 'rgba(30,45,61,0.5)' },
              ticks: { color: '#4a5a6a', font: { family: 'Space Mono', size: 9 }, callback: v => `$${v.toLocaleString()}` },
              position: 'right'
            }
          }
        }
      });
    }



    // ── QUICK TICKER ─────────────────────────────────────────────
    function quickTicker(symbol) {
      document.getElementById('tickerInput').value = symbol;
      runAnalysis();
    }

    // ── ENTER KEY ────────────────────────────────────────────────
    document.getElementById('tickerInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') runAnalysis();
    });

    // ── MAIN ANALYSIS CALL ───────────────────────────────────────
    async function runAnalysis() {
      const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
      const model = document.getElementById('modelSelect').value;
      const btn = document.getElementById('analyzeBtn');
      const errBox = document.getElementById('errorMsg');

      if (!ticker) return;

      // Reset error
      errBox.className = 'error-message';

      // Loading state
      btn.disabled = true;
      btn.className = 'analyze-btn loading';

      try {
        const res = await fetch(`${API_BASE}/analyze`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ticker, model })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || `HTTP ${res.status}`);
        }

        const data = await res.json();
        currentData = data;
        renderDashboard(data);
        addToHistory(data);

      } catch (err) {
        errBox.textContent = `Error: ${err.message}`;
        errBox.className = 'error-message visible';
      } finally {
        btn.disabled = false;
        btn.className = 'analyze-btn';
      }
    }

    // ── RENDER DASHBOARD ─────────────────────────────────────────
    function renderDashboard(data) {
      document.getElementById('emptyState').style.display = 'none';

      const raw = data.raw_analysis || {};
      const price = data.market_data_summary || {};
      const indicators = raw.indicators || {};
      const priceHistory = raw.price_history || [];
      const signal = (data.signal || 'HOLD').toUpperCase();
      const confidence = raw.confidence || 0;

      // Header
      document.getElementById('displayTicker').textContent = data.ticker;
      document.getElementById('displayPrice').textContent =
        price.price ? `$${Number(price.price).toFixed(2)}` : '—';

      const chg = price.change;
      const chgAbs = price.change_abs;
      const chgEl = document.getElementById('displayChange');
      if (chg !== undefined && chg !== null && chg !== 'N/A') {
        const num = parseFloat(chg);
        const absNum = parseFloat(chgAbs || 0);
        const sign = absNum >= 0 ? '+' : '-';
        chgEl.textContent = `${sign}$${Math.abs(absNum).toFixed(2)} | ${num >= 0 ? '+' : ''}${num.toFixed(2)}%`;
        chgEl.className = `ticker-change ${num >= 0 ? 'pos' : 'neg'}`;
      } else {
        chgEl.textContent = '';
      }

      document.getElementById('lastUpdated').textContent =
        'Updated ' + new Date().toLocaleTimeString('en-US', { hour12: false });

      // Signal badge
      const badge = document.getElementById('signalBadge');
      const icons = { BUY: '▲', SELL: '▼', HOLD: '◆' };
      badge.textContent = `${icons[signal] || '◆'} ${signal}`;
      badge.className = `signal-badge ${signal} visible`;

      // Confidence bar
      const confWrap = document.getElementById('confWrap');
      const confFill = document.getElementById('confFill');
      const confPct = document.getElementById('confPct');
      if (confidence) {
        confWrap.style.display = 'block';
        confFill.className = `confidence-fill ${signal}`;
        confPct.textContent = `${Math.round(confidence * 100)}%`;
        setTimeout(() => { confFill.style.width = `${confidence * 100}%`; }, 50);
      }

      // Reasoning
      const reasonBox = document.getElementById('reasoningBox');
      let reasoningTxt = data.reasoning || 'No reasoning provided.';

      // Secondary filter for tool-call remnants on frontend
      if (reasoningTxt.includes('{') && reasoningTxt.includes('}')) {
        try {
          const parsed = JSON.parse(reasoningTxt);
          if (parsed.name || parsed.parameters) {
            reasoningTxt = "Analysis complete. Waiting for reasoning summary...";
          }
        } catch (e) { }
      }

      reasonBox.textContent = reasoningTxt;
      reasonBox.className = 'reasoning-box visible';

      // Metrics
      renderMetrics(data, indicators);

      // Chart
      renderChart(priceHistory, signal);

      // Indicators
      renderIndicators(indicators);
    }

    // ── METRICS ──────────────────────────────────────────────────
    function renderMetrics(data, indicators) {
      const grid = document.getElementById('metricsGrid');
      grid.style.display = 'flex';

      const price = data.market_data_summary || {};
      const raw = data.raw_analysis || {};

      const metrics = [
        { label: 'Current Price', value: price.price ? `$${Number(price.price).toFixed(2)}` : '—', cls: '' },
        {
          label: 'Change %', value: price.change !== 'N/A' ? `${parseFloat(price.change).toFixed(2)}%` : '—',
          cls: parseFloat(price.change) >= 0 ? 'up' : 'down'
        },
        {
          label: 'RSI (14)', value: indicators.rsi ? indicators.rsi.toFixed(1) : '—',
          cls: indicators.rsi > 70 ? 'down' : indicators.rsi < 30 ? 'up' : 'neutral'
        },
        {
          label: 'MACD', value: indicators.macd ? indicators.macd.toFixed(3) : '—',
          cls: indicators.macd > 0 ? 'up' : 'down'
        },
        { label: 'Volume', value: raw.volume ? formatVolume(raw.volume) : '—', cls: '' },
        { label: 'Signal', value: data.signal || '—', cls: data.signal === 'BUY' ? 'up' : data.signal === 'SELL' ? 'down' : 'neutral' },
      ];

      grid.innerHTML = metrics.map((m, i) => `
      <div class="metric-card" id="mc${i}">
        <div class="metric-label">${m.label}</div>
        <div class="metric-value ${m.cls}">${m.value}</div>
      </div>
    `).join('');

      // Staggered reveal
      metrics.forEach((_, i) => {
        setTimeout(() => {
          const el = document.getElementById(`mc${i}`);
          if (el) el.classList.add('visible');
        }, i * 60);
      });
    }

    // ── CHART ────────────────────────────────────────────────────
    function renderChart(priceHistory, signal) {
      const panel = document.getElementById('chartPanel');
      panel.style.display = 'block';
      setTimeout(() => panel.classList.add('visible'), 50);

      // If no real history, generate plausible mock from signal
      let prices = priceHistory;
      if (!prices || prices.length < 5) {
        prices = generateMockPrices(40, signal);
      }

      if (chartInstance) { chartInstance.destroy(); }

      const ctx = document.getElementById('mainChart').getContext('2d');
      const labels = prices.map((_, i) => i === prices.length - 1 ? 'Now' : `-${prices.length - 1 - i}d`);

      const grad = ctx.createLinearGradient(0, 0, 0, 200);
      grad.addColorStop(0, 'rgba(0,212,255,0.18)');
      grad.addColorStop(1, 'rgba(0,212,255,0)');

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            data: prices,
            borderColor: '#00d4ff',
            borderWidth: 1.5,
            backgroundColor: grad,
            fill: true,
            tension: 0.3,
            pointRadius: 0,
            pointHoverRadius: 4,
            pointHoverBackgroundColor: '#00d4ff',
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#0d1117',
              borderColor: '#1e2d3d',
              borderWidth: 1,
              titleColor: '#4a5a6a',
              bodyColor: '#00d4ff',
              titleFont: { family: 'Space Mono', size: 10 },
              bodyFont: { family: 'Space Mono', size: 12 },
              callbacks: {
                label: ctx => ` $${ctx.parsed.y.toFixed(2)}`
              }
            }
          },
          scales: {
            x: {
              grid: { color: 'rgba(30,45,61,0.5)', drawBorder: false },
              ticks: {
                color: '#4a5a6a', font: { family: 'Space Mono', size: 9 },
                maxTicksLimit: 8
              }
            },
            y: {
              grid: { color: 'rgba(30,45,61,0.5)', drawBorder: false },
              ticks: {
                color: '#4a5a6a', font: { family: 'Space Mono', size: 9 },
                callback: v => `$${v.toFixed(0)}`
              },
              position: 'right'
            }
          }
        }
      });
    }

    function switchChart(type, el) {
      document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      currentChartType = type;
      // Re-render with same data (extend for RSI/MACD datasets as needed)
      if (currentData) {
        const raw = currentData.raw_analysis || {};
        renderChart(raw.price_history || [], currentData.signal);
      }
    }

    // ── INDICATORS ───────────────────────────────────────────────
    function renderIndicators(indicators) {
      const grid = document.getElementById('indicatorsGrid');
      grid.style.display = 'flex';

      const rsi = indicators.rsi;
      const macd = indicators.macd;
      const bb = indicators.bollinger || {};

      const items = [
        {
          name: 'RSI (14)',
          value: rsi ? rsi.toFixed(1) : '—',
          color: rsi > 70 ? 'var(--danger)' : rsi < 30 ? 'var(--accent2)' : 'var(--warn)',
          status: rsi > 70 ? 'Overbought — potential sell' : rsi < 30 ? 'Oversold — potential buy' : 'Neutral zone'
        },
        {
          name: 'MACD Signal',
          value: macd ? (macd > 0 ? `+${macd.toFixed(3)}` : macd.toFixed(3)) : '—',
          color: macd > 0 ? 'var(--accent2)' : 'var(--danger)',
          status: macd > 0 ? 'Bullish momentum' : 'Bearish momentum'
        },
        {
          name: 'SMA / EMA (20)',
          value: indicators.sma_20 ? indicators.sma_20.toFixed(2) : '—',
          color: 'var(--accent)',
          status: `EMA(20): $${indicators.ema_20 ? indicators.ema_20.toFixed(2) : '—'}`
        },
        {
          name: 'Mid-Term SMA (50)',
          value: indicators.sma_50 ? indicators.sma_50.toFixed(2) : '—',
          color: 'var(--warn)',
          status: indicators.sma_50 < (indicators.sma_20 || 0) ? 'Bullish crossover' : 'Bearish crossover'
        }
      ];

      grid.innerHTML = items.map((item, i) => `
      <div class="indicator-panel" id="ip${i}">
        <div class="indicator-name">${item.name}</div>
        <div class="indicator-value" style="color:${item.color}">${item.value}</div>
        <div class="indicator-status">${item.status}</div>
      </div>
    `).join('');

      items.forEach((_, i) => {
        setTimeout(() => {
          const el = document.getElementById(`ip${i}`);
          if (el) el.classList.add('visible');
        }, i * 80 + 200);
      });
    }

    // ── HISTORY ──────────────────────────────────────────────────
    function addToHistory(data) {
      analysisHistory.unshift({
        ticker: data.ticker,
        signal: data.signal,
        time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false })
      });
      if (analysisHistory.length > 8) analysisHistory.pop();

      const list = document.getElementById('historyList');
      list.innerHTML = analysisHistory.map(h => `
      <div class="history-item" onclick="quickTicker('${h.ticker}')">
        <div>
          <span class="history-ticker">${h.ticker}</span>
          <span style="font-size:0.68rem;color:var(--muted);margin-left:8px">${h.time}</span>
        </div>
        <span class="history-signal ${h.signal}">${h.signal}</span>
      </div>
    `).join('');
    }

    // ── HELPERS ──────────────────────────────────────────────────
    function formatVolume(v) {
      if (v >= 1e9) return `${(v / 1e9).toFixed(1)}B`;
      if (v >= 1e6) return `${(v / 1e6).toFixed(1)}M`;
      if (v >= 1e3) return `${(v / 1e3).toFixed(0)}K`;
      return v;
    }

    function generateMockPrices(n, signal) {
      // Generates a plausible trend based on signal for demo purposes
      let base = 150 + Math.random() * 100;
      const trend = signal === 'BUY' ? 0.003 : signal === 'SELL' ? -0.003 : 0.0005;
      return Array.from({ length: n }, (_, i) => {
        base = base * (1 + trend + (Math.random() - 0.5) * 0.015);
        return parseFloat(base.toFixed(2));
      });
    }

    // ── CAPITAL ALLOCATION ───────────────────────────────────────
    async function setAgentAllocation() {
      const val = document.getElementById('agentAllocInput').value;
      try {
        const res = await fetch(`${API_BASE}/agent/allocation`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount: parseFloat(val) })
        });
        const data = await res.json();
        alert(`Agent capital set to $${data.allocated}`);
        loadAccount(); // refresh
      } catch (e) { alert('Failed to set allocation'); }
    }

    // ── PORTFOLIO SWICHING ───────────────────────────────────────
    let currentPortView = 'total';
    let fullAccountData = null; // Store for switching

    function switchPortView(mode) {
      currentPortView = mode;
      document.getElementById('btnPortTotal').classList.toggle('active', mode === 'total');
      document.getElementById('btnPortAgent').classList.toggle('active', mode === 'agent');
      if (fullAccountData) renderAccountData(fullAccountData);
    }

    async function loadAccount() {
      try {
        const res = await fetch(`${API_BASE}/account`);
        fullAccountData = await res.json();

        // Update input if not focused (so we see current alloc)
        if (document.activeElement.id !== 'agentAllocInput') {
          const ag = fullAccountData.agent_portfolio || {};
          document.getElementById('agentAllocInput').value = ag.allocated || 0;
        }

        renderAccountData(fullAccountData);
      } catch (e) { console.error('Account load error', e); }
    }

    function renderAccountData(data) {
      const equityEl = document.getElementById('accEquity');
      const bpEl = document.getElementById('accBuyingPower');
      const cashEl = document.getElementById('accCash');
      const profitEl = document.getElementById('accNetProfit');
      const lossEl = document.getElementById('accNetLoss');
      const drawdownEl = document.getElementById('accDrawdown');
      const list = document.getElementById('positionList');

      // Show/hide simulation badge
      document.getElementById('simModeBadge').style.display =
        (data.status === 'active' && data.mode === 'simulation') ? 'inline-block' : 'none';

      if (data.status === 'inactive') {
        list.innerHTML = `<tr><td colspan="8" style="text-align:center; color:var(--danger); padding:30px">Trading Service Inactive (Check API Keys)</td></tr>`;
        return;
      }

      let displayData = data;
      if (currentPortView === 'agent') {
        const ag = data.agent_portfolio || { cash: 0, equity: 0, positions: {} };
        const positionsList = Object.entries(ag.positions || {}).map(([k, v]) => ({
          symbol: k, ...v
        }));

        displayData = {
          equity: ag.equity || 0,
          buying_power: ag.cash || 0,
          cash: ag.cash || 0,
          positions: positionsList
        };
      }

      equityEl.textContent = `$${Number(displayData.equity).toLocaleString()}`;
      bpEl.textContent = `$${Number(displayData.buying_power).toLocaleString()}`;
      cashEl.textContent = `$${Number(displayData.cash).toLocaleString()}`;

      // Calculate Metrics
      let netProfit = 0;
      let netLoss = 0;
      let topPerformers = [];

      if (displayData.positions && displayData.positions.length > 0) {
        displayData.positions.forEach(p => {
          const pl = parseFloat(p.unrealized_pl || 0);
          if (pl >= 0) netProfit += pl;
          else netLoss += Math.abs(pl);
          topPerformers.push({ symbol: p.symbol, pl: pl });
        });
      }

      profitEl.textContent = `$${netProfit.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      lossEl.textContent = `$${netLoss.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

      // Calculate Drawdown from Performance History
      updateDrawdown(drawdownEl);

      // Render Top Performers Chart
      renderTopPerformers(topPerformers);

      if (!displayData.positions || displayData.positions.length === 0) {
        list.innerHTML = `<tr><td colspan="8" style="text-align:center; color:var(--muted); padding:30px">No open positions.</td></tr>`;
      } else {
        list.innerHTML = displayData.positions.map(p => {
          const pl = parseFloat(p.unrealized_pl || 0);
          const plpc = parseFloat(p.unrealized_plpc || 0) * 100;
          const cls = pl >= 0 ? 'pl-up' : 'pl-down';

          // Detect if it's a pending trade in Agent view (no price info yet)
          const isPending = !p.current_price || p.current_price === 0;

          const sl = p.stop_loss && p.stop_loss > 0 ? `$${p.stop_loss.toFixed(2)}` : '—';
          const risk = p.risk_score || 0;
          let riskCls = 'risk-low';
          if (risk > 7) riskCls = 'risk-high';
          else if (risk > 4) riskCls = 'risk-med';

          const riskLabel = risk > 0 ? `${risk}/10` : '—';

          return `
              <tr>
                <td style="font-weight:bold">${p.symbol}</td>
                <td>${p.qty}</td>
                <td>${isPending ? 'PENDING' : '$' + Number(p.avg_entry_price).toFixed(2)}</td>
                <td>${isPending ? '—' : '$' + Number(p.current_price).toFixed(2)}</td>
                <td style="font-family: var(--mono); font-size: 0.75rem">${sl}</td>
                <td><span class="risk-badge ${riskCls}">${riskLabel}</span></td>
                <td class="${isPending ? '' : cls}">${isPending ? '—' : (pl >= 0 ? '+' : '') + '$' + pl.toFixed(2)}</td>
                <td class="${isPending ? '' : cls}">${isPending ? '—' : (pl >= 0 ? '+' : '') + plpc.toFixed(2) + '%'}</td>
              </tr>
            `;
        }).join('');
      }

      const orderContainer = document.getElementById('pendingOrdersContainer');
      const orderList = document.getElementById('orderList');
      if (data.pending_orders && data.pending_orders.length > 0 && currentPortView === 'total') {
        orderContainer.style.display = 'block';
        orderList.innerHTML = data.pending_orders.map(o => `
            <tr>
              <td style="font-weight:bold">${o.symbol}</td>
              <td class="${o.side === 'buy' ? 'pl-up' : 'pl-down'}" style="font-weight:bold">${o.side.toUpperCase()}</td>
              <td>${o.qty}</td>
              <td style="color: var(--warn); font-family: var(--mono); font-size: 0.7rem">${o.status.toUpperCase()}</td>
              <td style="font-family: var(--mono); font-size: 0.7rem; color: var(--muted)">${new Date(o.submitted_at).toLocaleTimeString()}</td>
            </tr>
          `).join('');
      } else {
        orderContainer.style.display = 'none';
      }
    }

    async function updateDrawdown(el) {
      try {
        const res = await fetch(`${API_BASE}/performance`);
        const history = await res.json();
        if (!history || history.length === 0) {
          el.textContent = '0.00%';
          return;
        }

        let peak = -Infinity;
        let maxDD = 0;

        history.forEach(point => {
          if (point.equity > peak) peak = point.equity;
          const dd = (peak - point.equity) / peak;
          if (dd > maxDD) maxDD = dd;
        });

        el.textContent = `${(maxDD * 100).toFixed(2)}%`;
      } catch (e) {
        console.error('Drawdown calc error', e);
        el.textContent = 'N/A';
      }
    }

    function renderTopPerformers(data) {
      const ctx = document.getElementById('topPerformersChart').getContext('2d');

      // Sort and take top 5
      const sorted = data.sort((a, b) => b.pl - a.pl).slice(0, 5);

      if (topPerformersChartInstance) {
        topPerformersChartInstance.destroy();
      }

      if (sorted.length === 0) {
        return;
      }

      topPerformersChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sorted.map(d => d.symbol),
          datasets: [{
            label: 'P&L ($)',
            data: sorted.map(d => d.pl),
            backgroundColor: sorted.map(d => d.pl >= 0 ? 'rgba(0, 255, 136, 0.4)' : 'rgba(255, 71, 87, 0.4)'),
            borderColor: sorted.map(d => d.pl >= 0 ? '#00ff88' : '#ff4757'),
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#6a7c8d', font: { family: 'Space Mono', size: 10 } }
            },
            y: {
              grid: { display: false },
              ticks: { color: '#00d4ff', font: { family: 'Space Mono', size: 10, weight: 'bold' } }
            }
          }
        }
      });
    }

    // ── GLOBE VISUALIZATION ──────────────────────────────────────
    const HQ_COORDS = {
      'AAPL': { lat: 37.33, lng: -122.03, label: 'Apple HQ (Cupertino)' },
      'GOOGL': { lat: 37.42, lng: -122.08, label: 'Google HQ (Mountain View)' },
      'MSFT': { lat: 47.67, lng: -122.12, label: 'Microsoft HQ (Redmond)' },
      'TSLA': { lat: 30.22, lng: -97.62, label: 'Tesla HQ (Austin)' },
      'NVDA': { lat: 37.38, lng: -121.97, label: 'Nvidia HQ (Santa Clara)' },
      'AMZN': { lat: 47.60, lng: -122.33, label: 'Amazon HQ (Seattle)' },
      'META': { lat: 37.48, lng: -122.14, label: 'Meta HQ (Menlo Park)' },
      'NFLX': { lat: 37.25, lng: -121.96, label: 'Netflix HQ (Los Gatos)' },
      'BTC-USD': { lat: 13.69, lng: -89.21, label: 'El Salvador (Bitcoin City)' }, // Fun reference
      'ETH-USD': { lat: 46.94, lng: 7.44, label: 'Ethereum (Zug, Switzerland)' }
    };

    let world = null;

    function initGlobe() {
      const elem = document.getElementById('globeViz');
      world = Globe()
        (elem)
        .backgroundColor('rgba(0,0,0,0)')
        .width(elem.clientWidth)
        .height(200)
        .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
        .pointOfView({ lat: 20, lng: 0, altitude: 2.5 });

      // Add auto-resize
      window.addEventListener('resize', () => {
        world.width(elem.clientWidth);
      });
    }

    // Call init after a slight delay to ensure container exists
    setTimeout(initGlobe, 1000);

    function updateGlobe(ticker) {
      document.getElementById('globeViz').style.display = 'block';
      const coords = HQ_COORDS[ticker] || { lat: 20, lng: 0, label: 'Unknown HQ' };

      const data = [{
        lat: coords.lat,
        lng: coords.lng,
        size: 0.25,
        color: '#00d4ff'
      }];

      // Rings for "pointing" effect
      const rings = [{
        lat: coords.lat,
        lng: coords.lng,
        maxR: 8,
        propagationSpeed: 4,
        repeatPeriod: 800
      }];

      // Label
      const labels = [{
        lat: coords.lat,
        lng: coords.lng,
        text: coords.label,
        color: '#c9d4e0',
        size: 1.5,
        resolution: 2
      }];

      world.pointsData(data)
        .pointAltitude(0.1)
        .pointColor('color');

      world.ringsData(rings)
        .ringColor(() => '#00ff88')
        .ringMaxRadius('maxR')
        .ringPropagationSpeed('propagationSpeed')
        .ringRepeatPeriod('repeatPeriod');

      world.labelsData(labels)
        .labelLat('lat')
        .labelLng('lng')
        .labelText('text')
        .labelColor('color')
        .labelSize('size')
        .labelDotRadius(0.5)
        .labelAltitude(0.05);

      world.pointOfView({ lat: coords.lat, lng: coords.lng, altitude: 1.8 }, 1500);
    }

    // Hook into renderDashboard to update globe
    const originalRender = renderDashboard;
    renderDashboard = function (data) {
      originalRender(data);
      updateGlobe(data.ticker);
    };
  </script>

</body>

</html>